# Rank students based on the average quiz result per course
WITH AvgScores AS (

    SELECT
        e.CourseID,
        e.UserID,
        AVG(qa.Score) AS AvgScore
    FROM
        Enrollment e
        JOIN QuizAttempt qa ON e.UserID = qa.UserID
        JOIN Quiz q ON qa.QuizID = q.QuizID
    GROUP BY
        e.CourseID,
        e.UserID
),
RankedStudents AS (

    SELECT
        CourseID,
        UserID,
        AvgScore,
        ROW_NUMBER() OVER (PARTITION BY CourseID ORDER BY AvgScore DESC) AS Rank
    FROM
        AvgScores
),
# Identify the top five in each day
SELECT
    CourseID,
    UserID,
    AttemptDate,
    AvgScore,
    Rank
FROM
    RankedStudents
WHERE
    AttemptDate = CURDATE() 
    AND Rank <= 5
ORDER BY
    CourseID,
    Rank;
# Rank the top instructors according to the number of their students existing in top scores per quizzes.
InstructorStudentCount AS (

    SELECT
        u.UserID AS InstructorID,
        COUNT(DISTINCT ts.UserID) AS TopStudentCount
    FROM
        TopStudents ts
        JOIN Enrollment e ON ts.UserID = e.UserID
        JOIN Course c ON e.CourseID = c.CourseID
        JOIN User u ON c.InstructorID = u.UserID
    GROUP BY
        u.UserID
)

SELECT
    i.UserID AS InstructorID,
    i.Username AS InstructorName,
    isc.TopStudentCount,
    ROW_NUMBER() OVER (ORDER BY isc.TopStudentCount DESC) AS InstructorRank
FROM
    InstructorStudentCount isc
    JOIN User i ON isc.InstructorID = i.UserID;
